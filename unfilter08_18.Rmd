---
title: "Skin Bleaching Analysis In The US 2008 - 2018"
author: "Steven Lawrence"
date: "November 18, 2019"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---
###Packages Used

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

# global default settings for chunks
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE,
                      fig.dim = c(6, 3)
                      )

# loaded packages; placed here to be able to load global settings
#install.packages(c("kableExtra", "patchwork","DescTools","tidyverse","tseries","DataCombine","forecast","plotly","ggpubr","gridExtra","pastecs"))
#tinytex::install_tinytex()


Packages <- c("tidyverse", "arsenal", "readxl", 
              "patchwork", "GGally", "ghibli","plotly","ggpubr","gridExtra",
              "pastecs","forecast","DataCombine","tseries","kableExtra","viridis")
invisible(lapply(Packages, library, character.only = TRUE))


# theme global setting for ggplot
theme_set(theme_minimal() + 
            theme(legend.position = "bottom") +
            theme(plot.title = element_text(hjust = 0.5, size = 12),
                  plot.subtitle = element_text(hjust = 0.5, size = 8))
          )
```
#Skin Bleaching Time Series Analysis

##Distribution

Here I am loading in the data.  This dataset contains information for years 2004 - 2019, however only 2008 onward will be analyzed.

```{r Skin Bleaching Temoral Datasets, message=FALSE, warning=FALSE}

skbt<- read.csv("./data/GtrendData/bleachingTime08_18.csv", header = T, sep = ",",stringsAsFactors = F, col.names = c("time","rsv"))

skbt<- skbt[-1,] %>% 
 mutate(rsv = as.numeric(rsv)) %>% 
  rename(
    date = time) %>% 
    separate(date, into = c("year","month"), sep = "\\-" ) %>% 
  mutate(
    month = as.numeric(month),
    month_name = month.abb[month],
    year_f = as.factor(year),
    month_name = as.factor(month_name)) %>%
  arrange(year)

```

```{r, message=F, warning=F}

skbt %>%
  
  ggplot(aes(x = rsv))+geom_histogram()+labs(title = "Distribution of Relative Search Volume between 2008 - 2018")


```

```{r, eval=FALSE, message=F, warning=F}

skbt %>% 
  pivot_wider(
    names_from = month_name,
    values_from  = rsv
  ) %>%
    as_tibble() 
```

```{r, message=F, warning=F}
 
skbt  %>% 
   ggplot(aes(x = month_name, y = rsv))+
   geom_violin()+
   ggtitle("Distibution of Relative Search Volume By Month for years 2008 - 2018")



```

Plotting the temporal trend

```{r, message=F, warning=F}



b0<- skbt  %>%
  mutate(
         month_name  = forcats::fct_relevel(month_name, "Jan", "Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"),
         month_cont = c(1:132)) %>% 
  ggplot(aes(x = month_cont, y = rsv, col = year_f))+geom_line()+
 labs(
    title = "SKin Bleaching Trend from 2004 To 2018", 
    x = "Months", 
    y = "Relative Search Volume"
    ) +
  scale_fill_viridis_d(option = "A", aesthetics = "col")+theme(legend.position = "bottom")

b1<- skbt %>% 
  ggplot(aes(x=month_name, y= rsv, col = year_f, group = year
             ))+geom_line()+
  scale_fill_viridis_d(option = "A", aesthetics = "col")+
  labs(title = "Seasonal Plot of Relative Search Volume for years 2008 - 2018")+theme(legend.position = "bottom")


ggarrange(b0,b1, 
          #widths = c(2,3), 
          ncol = 2)

```




```{r, message=F, warning=F}
skbt  %>% 
  PercChange( Var = "rsv", slideBy = -1) %>% 
  summary() %>% 
  knitr::kable()


```

```{r, message=F, warning=F}
skbt %>% 
  pull(rsv) %>% 
  ts(frequency = 12) %>% 
  stl( s.window = "periodic") %>% 
plot()


```



```{r, message=F, warning=F}
skbt %>%
  pull(rsv) %>% 
  ggAcf()

 skbt %>%
   pull(rsv) %>% 
  ts() %>%  
  pastecs::trend.test(R = 1) %>% 
   broom::tidy() %>% 
   select(method, estimate, p.value) %>% 
   rename("r" = estimate) %>% 
   knitr::kable()


```



```{r}
 skbt %>% 
  pull(rsv) %>% 
  na.omit() %>% 
  ts(frequency = 12) %>% 
      stl( s.window = "periodic") %>% 
  seasadj() %>% 
  ggsubseriesplot(main = "Skin Bleaching")

```

#Skin Bleaching Regional Analysis


```{r}
skbr <- read.csv("./data/GtrendData/bleachingRegion08_18.csv", header = T, sep = ",",stringsAsFactors = F, col.names = c("region","rsv"))

skbr<- skbr[-1,] %>% 
 mutate(rsv = as.numeric(rsv)) %>% 
  rename(state = region)


```

```{r}
skbr %>% 
  mutate(rsv = recode(rsv, .missing = 0)) %>% 
  ggplot(aes(x = rsv))+geom_histogram(bins = 30 )+labs(title = "Distribution of Regional Relative Search Intersts for year 2008 - 2018")
```

## Choropleth map

```{r}

# used this data set to obtain state codes used in plotly to map according to state
codes <- read_csv("https://raw.githubusercontent.com/plotly/datasets/master/2011_us_ag_exports.csv") %>% 
  select(state, code)

# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)

# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

#merging both the codes and rsv together within ploty commands using left_join.
p <- plot_geo(
      #data set
      left_join(codes, skbr, by = "state"), 
      #map
      locationmode = 'USA-states') %>%
    add_trace(
      z = ~rsv, 
      #text = ~hover, 
      locations = ~code,
      color = ~rsv, colors = 'Purples'
  ) %>%
    colorbar(title = "Volume In Percentage") %>%
    layout(
      title = 'Relative Search Volume of <br> Skin Bleaching in The US 2008 - 2018',
      geo = g
  )

p

```

