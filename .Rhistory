ggplot(aes(x = trend_strength, y = seasonal_strength_year)) +
geom_point(#aes(
#  col = ifelse(state %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI"), "blue","red"),
#  col = region)
) +
geom_label_repel(
aes(label = state ),
data =  . %>% filter(trend_strength > 0.6 & seasonal_strength_year > 0.4),
box.padding   = 0.35,
point.padding = 0.5,
segment.color = 'grey50',
size = 3
) +
#   theme(legend.position = "none")+
scale_fill_viridis_d(aes(col = region))
##################################################
most_seasonal <- states_q %>%
features(hits, feat_stl) %>%
filter(trend_strength %notin% NaN ) %>%
filter(seasonal_strength_year == max(seasonal_strength_year))
states_q %>%
right_join(most_seasonal, by =c("state")) %>%
ggplot(aes(x = yearquater, y = hits)) + geom_line()+
ggtitle("Texus")
most_trend <- states_q %>%
features(hits, feat_stl) %>%
filter(trend_strength %notin% NaN ) %>%
filter(trend_strength == max(trend_strength))
states_q %>%
right_join(most_trend, by = c("state")) %>%
ggplot(aes(x = yearquater, y = hits)) + geom_line() +
ggtitle("California")
q1 + q2
test_s <-  states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) #%>%
# filter(state %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI"))
#seasonal and trend strength
q1 <- states_q %>% #data by quarter
mutate(region = as_factor(region)) %>%
features(hits, feat_stl) %>%
ggplot(aes(x = trend_strength, y = seasonal_strength_year)) +
geom_point(#aes(
#  col = ifelse(state %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI"), "blue","red"),
#  col = region)
) +
geom_label_repel(
aes(label = state ),
data =  . %>% filter(state  %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI")),
box.padding   = 0.35,
point.padding = 0.5,
segment.color = 'grey50',
size = 3
) +
#   theme(legend.position = "none")+
scale_fill_viridis_d(aes(col = region))
q2 <- states_q %>% #data by quarter
mutate(region = as_factor(region)) %>%
features(hits, feat_stl) %>%
ggplot(aes(x = trend_strength, y = seasonal_strength_year)) +
geom_point(#aes(
#  col = ifelse(state %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI"), "blue","red"),
#  col = region)
) +
geom_label_repel(
aes(label = state ),
data =  . %>% filter(trend_strength > 0.6 & seasonal_strength_year > 0.4),
box.padding   = 0.35,
point.padding = 0.5,
segment.color = 'grey50',
size = 3
) +
#   theme(legend.position = "none")+
scale_fill_viridis_d(aes(col = region))
##################################################
most_seasonal <- states_q %>%
features(hits, feat_stl) %>%
filter(trend_strength %notin% NaN ) %>%
filter(seasonal_strength_year == max(seasonal_strength_year))
t1<-  states_q %>%
right_join(most_seasonal, by =c("state")) %>%
ggplot(aes(x = yearquater, y = hits)) + geom_line()+
ggtitle("Texus")
most_trend <- states_q %>%
features(hits, feat_stl) %>%
filter(trend_strength %notin% NaN ) %>%
filter(trend_strength == max(trend_strength))
c1<- states_q %>%
right_join(most_trend, by = c("state")) %>%
ggplot(aes(x = yearquater, y = hits)) + geom_line() +
ggtitle("California")
q1 + q2 +t1 +c1
test_s <-  states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) #%>%
# filter(state %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI"))
#seasonal and trend strength
q1 <- states_q %>% #data by quarter
mutate(region = as_factor(region)) %>%
features(hits, feat_stl) %>%
ggplot(aes(x = trend_strength, y = seasonal_strength_year)) +
geom_point(#aes(
#  col = ifelse(state %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI"), "blue","red"),
#  col = region)
) +
geom_label_repel(
aes(label = state ),
data =  . %>% filter(state  %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI")),
box.padding   = 0.35,
point.padding = 0.5,
segment.color = 'grey50',
size = 3
) +
#   theme(legend.position = "none")+
scale_fill_viridis_d(aes(col = region))
q2 <- states_q %>% #data by quarter
mutate(region = as_factor(region)) %>%
features(hits, feat_stl) %>%
ggplot(aes(x = trend_strength, y = seasonal_strength_year)) +
geom_point(#aes(
#  col = ifelse(state %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI"), "blue","red"),
#  col = region)
) +
geom_label_repel(
aes(label = state ),
data =  . %>% filter(trend_strength > 0.6 & seasonal_strength_year > 0.4),
box.padding   = 0.35,
point.padding = 0.5,
segment.color = 'grey50',
size = 3
) +
#   theme(legend.position = "none")+
scale_fill_viridis_d(aes(col = region))
##################################################
most_seasonal <- states_q %>%
features(hits, feat_stl) %>%
filter(trend_strength %notin% NaN ) %>%
filter(seasonal_strength_year == max(seasonal_strength_year))
t1<-  states_q %>%
right_join(most_seasonal, by =c("state")) %>%
ggplot(aes(x = yearquater, y = hits)) + geom_line()+
ggtitle("Texus")
most_trend <- states_q %>%
features(hits, feat_stl) %>%
filter(trend_strength %notin% NaN ) %>%
filter(trend_strength == max(trend_strength))
c1<- states_q %>%
right_join(most_trend, by = c("state")) %>%
ggplot(aes(x = yearquater, y = hits)) + geom_line() +
ggtitle("California")
q1 + q2
t1 +c1
autolayer(dcmp, trend,col = "blue")
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
# filter(state %in% c("NY","CA","NJ","TX")) %>%
autoplot(hits, aspect.ratio = 0.03) +
theme(legend.position = "none") %>%
autolayer(dcmp, trend,col = "blue")
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
# filter(state %in% c("NY","CA","NJ","TX")) %>%
autoplot(hits, aspect.ratio = 0.03) +
theme(legend.position = "none") +
autolayer(dcmp, trend,col = "blue")
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
# filter(state %in% c("NY","CA","NJ","TX")) %>%
autoplot(hits) +
theme(legend.position = "none", aspect.ratio = 0.03) +
autolayer(dcmp, trend,col = "blue")
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
# filter(state %in% c("NY","CA","NJ","TX")) %>%
autoplot(hits, alpha = 2) +
theme(legend.position = "none") +
autolayer(dcmp, trend,col = "blue")
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
# filter(state %in% c("NY","CA","NJ","TX")) %>%
autoplot(hits) +
theme(legend.position = "none") +
autolayer(dcmp, trend,col = "blue",, alpha = 2)
dcmp <- states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
#filter(state %in% c("NY","CA","NJ","TX")) %>%
model(stl = STL(hits ~ season(window = 13) + trend(window = 10), robust = T)) %>%
components()
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
# filter(state %in% c("NY","CA","NJ","TX")) %>%
autoplot(hits) +
theme(legend.position = "none") +
autolayer(dcmp, trend,col = "blue",, alpha = 2)
dcmp %>% autoplot()
dcmp %>% gg_subseries(season_year)
dcmp <- states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
#filter(state %in% c("NY","CA","NJ","TX")) %>%
model(stl = STL(hits ~ season(window = 13) + trend(window = 10), robust = T)) %>%
components()
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
# filter(state %in% c("NY","CA","NJ","TX")) %>%
autoplot(hits) +
theme(legend.position = "none") +
autolayer(dcmp, trend,col = "blue", alpha = 2)
dcmp %>% autoplot()
#dcmp %>% gg_subseries(season_year)
#dcmp %>% gg_season(hits, label = "right")
overall_trend$interest_over_time %>%
select(date, hits)  %>%
# unite("date", date:day,sep = "-") %>%
mutate( yearMonth = yearmonth(date)) %>%
select(yearMonth, hits,  -date) %>%
as_tsibble(index = yearMonth) %>%
gg_subseries(hits) +
labs(y = "RSV", x = "none")
overall_trend$interest_over_time %>%
select(date, hits)  %>%
# unite("date", date:day,sep = "-") %>%
mutate( yearMonth = yearmonth(date)) %>%
select(yearMonth, hits,  -date) %>%
as_tsibble(index = yearMonth) %>%
gg_subseries(hits) +
labs(y = "RSV", x = "")
overall_trend$interest_over_time %>%
select(date, hits)  %>%
# unite("date", date:day,sep = "-") %>%
mutate( yearMonth = yearmonth(date)) %>%
select(yearMonth, hits,  -date) %>%
as_tsibble(index = yearMonth) %>%
autoplot()+
labs(y = "Relative Search Volume", x = "")
states_q %>%
autoplot(hits) +
theme(legend.position = "none") +
autolayer(dcmp, trend,col = "blue", alpha = 2)
dcmp2 <- states_q %>%
model(stl = STL(hits ~ season(window = 13) + trend(window = 10), robust = T)) %>%
components()
dcmp2 %>% autoplot()
dcmp2 %>% autoplot() +
theme(legend.position = "none")
dcmp <- states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
#filter(state %in% c("NY","CA","NJ","TX")) %>%
model(stl = STL(hits ~ season(window = 13) + trend(window = 10), robust = T)) %>%
components()
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
# filter(state %in% c("NY","CA","NJ","TX")) %>%
autoplot(hits) +
theme(legend.position = "none") +
autolayer(dcmp, trend,col = "blue", alpha = 2)
dcmp %>% autoplot()
states_q %>%
autoplot(hits) +
theme(legend.position = "none") +
autolayer(dcmp, trend,col = "blue", alpha = 2)
dcmp2 <- states_q %>%
model(stl = STL(hits ~ season(window = 13) + trend(window = 10), robust = T)) %>%
components()
dcmp2 %>% autoplot() +
theme(legend.position = "none")
#dcmp %>% gg_subseries(season_year)
#dcmp %>% gg_season(hits, label = "right")
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearquater = yearquarter(date)) %>%
select(-date) %>%
group_by(yearquater, state) %>%
# summarise(hits = sum(hits)) %>%
arrange(state) %>%
as_tsibble(index = yearquater, key = state)
# extracting outliers
outliers <- pcs %>%
filter(.fittedPC1 > 4000 | .fittedPC2 < -500)
#ploting outliers
outliers %>% left_join(states_q, by = c("state","region")) %>%
mutate(series = glue("{state}","{region}", .sep = "\n")) %>%
ggplot(aes(x = yearquater, y = hits/max(hits)))+geom_line()+
facet_grid(series ~.)+
ggtitle("Outlying time series in PC space")
# extracting outliers
outliers <- pcs %>%
filter(.fittedPC1 > 4000 | .fittedPC2 < -500)
#ploting outliers
outliers %>% left_join(states_q, by = c("state","region")) %>%
mutate(series = glue("{state}","{region}", .sep = "\n")) %>%
ggplot(aes(x = yearquater, y = hits/max(hits)))+geom_line()+
facet_grid(series ~.)+
ggtitle("Outlying time series in PC space")
# How related are the time series
s1 <- pcs %>%
mutate(state = as_factor(state)) %>%
ggplot( aes(x = .fittedPC1,
y = .fittedPC2,
group = ifelse(state %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI"),"red","black" ),
col = region
)
) +
geom_point(aes(label = state #,
#col = ifelse(state %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI"),"red","black" )
)
)+
geom_label_repel(
data =  . %>% filter(state  %in% c("NY","CA","NJ","TX","MD","DC","NV","GA", "FL","MI")),
aes(label = state),
box.padding   = 0.5,
point.padding = 0.5,
segment.color = 'grey50',
size = 2) +
theme(legend.position = "none", aspect.ratio = 1)
r1 <- pcs %>%
ggplot(aes(x = .fittedPC1, y =.fittedPC2, col = region)) +
geom_point() +
geom_label_repel(aes(label = state),
data =  . %>% filter(.fittedPC1 > 4000 | .fittedPC2 < -500),
box.padding   = 0.35,
point.padding = 0.5,
segment.color = 'grey50',
size = 2) +
theme(legend.position = "right",
aspect.ratio = 1)
s1 + r1
View(q2)
View(r1)
# global default settings for chunks
knitr::opts_chunk$set( eval = TRUE, warning = FALSE, message = FALSE,
# fig.dim = c(6, 3)
fig.width = 9,
fig.height = 5,
dpi = 144,
fig.pos = "!h"
)
Packages <- c("tidyverse", "arsenal", "readxl",
"patchwork", "GGally", "ghibli",
"plotly","ggpubr","gridExtra",
"pastecs","DataCombine", "ggrepel",
"tseries","kableExtra","viridis",
"RColorBrewer", "fabletools", "gtrendsR",
"fpp3","tsibble", "formattable", "forecast",
"glue")
invisible(lapply(Packages, library, character.only = TRUE))
# theme global setting for ggplot
#theme_set(theme_minimal() +
#            theme(legend.position = "bottom") +
#           theme(plot.title = element_text(hjust = 0.5, size = 12),
#                plot.subtitle = element_text(hjust = 0.5, size = 8))
#         )
write.csv(states, "statesTS.csv")
states <- read_csv(/"statesTS.csv")
states <- read_csv("./statesTS.csv")
states
#adding regions to data set
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
filter(state %in% c("NY","CA","TX","NJ")) %>%
gg_subseries(hits)
colnames(states)[col] <-  sub("*.region.", "", colnames(states)[col])
colnames(states)[col] <-  sub("region.*", "", colnames(states)[col])
colnames(states[,-1])[col] <-  sub("region.*", "", colnames(states[,-1])[col])
colnames(states[,-1])[col] <-  sub("_region.*", "", colnames(states[,-1])[col])
colnames(states[,-1])[col]
sub("_region.*", "", colnames(states[,-1])[col])
colnames(states[,-1])[col] <-  gsub("region.", "", colnames(states[,-1])[col])
colnames(states)[col] <-  gsub("region.", "", colnames(states)[col])
colnames(states)[col] <-  gsub("region.", "", colnames(states)[col])
states %>% mutate(col = str_remove(col, 'region.*'))
states %>% rename_at(vars(select(contains("remove."))), "")
states %>% rename_at(select(contains("remove.")), "")
states %>% rename_at(vars(contains("remove.")), "")
names(states[,-1]) <- substring(names(states[,-1]), 4)
states
names(states) <- substring(names(states), 4)
states
states <- read_csv("./statesTS.csv")
names(states) <- substring(names(states), 8)
states
#adding regions to data set
states %>%
tibble() %>%
unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
filter(state %in% c("NY","CA","TX","NJ")) %>%
gg_subseries(hits)
states %>%
tibble()
states %>%
tibble() %>%
unnest()
#adding regions to data set
states %>%
#tibble() %>%
#unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearmonth = yearmonth(date)) %>%
select(-date) %>%
as_tsibble(index = yearmonth, key = state) %>%
filter(state %in% c("NY","CA","TX","NJ")) %>%
gg_subseries(hits)
states_q <- states %>%
#tibble() %>%
#unnest() %>%
separate(geo, into = c("country","state")) %>%
select(date,hits,state) %>%
mutate(yearquater = yearquarter(date)) %>%
select(-date) %>%
group_by(yearquater, state) %>%
summarise(hits = sum(hits)) %>%
arrange(state) %>%
as_tsibble(index = yearquater, key = state)
state_region <- tibble(
name = c(state.name,"DistrictofColumbia"),
region = c(as.character(state.region), "South"),
state = c(state.abb, "DC")
)
states_q <- left_join(states_q, state_region, by = "state")
states_q %>%
filter(state %in% c("NY","CA","TX","NJ")) %>%
gg_subseries(hits)
